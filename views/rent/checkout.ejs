<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .summary-card { border-left: 5px solid #0d6efd; }
        .payment-option { cursor: pointer; }
        .payment-option:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <%- include('../shared/header.ejs') %>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h1 class="mb-4">Complete Your Booking</h1>

                <% if (messages.error) { %>
                    <div class="alert alert-danger"><%= messages.error %></div>
                <% } %>

                <div class="card summary-card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Booking Summary</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Room: <%= contract.room_number %></h5>
                        <p class="card-text"><%= contract.description %></p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Contract ID:</strong> <%= contract.id %></li>
                            <li class="list-group-item"><strong>Rental Period:</strong> <%= new Date(contract.start_date).toLocaleDateString() %> to <%= new Date(contract.end_date).toLocaleDateString() %></li>
                            <li class="list-group-item fs-4">
                                <strong>Total:</strong> 
                                <span class="fw-bold text-primary"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(contract.total_rent) %></span>
                            </li>
                        </ul>
                    </div>
                </div>

                <h3 class="mb-3">Choose Payment Method</h3>

                <form action="/renting/pay" method="POST" id="paymentForm">
                    <input type="hidden" name="contract_id" value="<%= contract.id %>">
                    <input type="hidden" name="payment_method" id="paymentMethodInput" value="">

                    <div class="list-group">
                        <!-- Pay with Cash -->
                        <a href="#" class="list-group-item list-group-item-action payment-option" data-method="cash">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Pay with Cash</h5>
                                <small>In Person</small>
                            </div>
                            <p class="mb-1">Complete your payment with our staff to activate the booking. You will receive a confirmation once the payment is processed.</p>
                        </a>
                        <!-- Pay with Card -->
                        <a href="#" class="list-group-item list-group-item-action payment-option" data-method="card">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Pay with Credit/Debit Card</h5>
                                <small>Online</small>
                            </div>
                            <p class="mb-1">Proceed with a secure online payment. Your booking will be activated immediately upon successful payment.</p>
                            <!-- Mock card input fields -->
                            <div id="card-details" class="mt-3" style="display: none;">
                                <div class="mb-2"><input type="text" id="cardNumber" class="form-control" placeholder="Card Number"></div>
                                <div class="row">
                                    <div class="col-md-6 mb-2"><input type="text" id="cardExpiry" class="form-control" placeholder="MM/YY"></div>
                                    <div class="col-md-6 mb-2"><input type="text" id="cardCvc" class="form-control" placeholder="CVC"></div>
                                </div>
                                <button type="button" id="pay-by-card-btn" class="btn btn-primary mt-2">Pay Now</button>
                            </div>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const paymentForm = document.getElementById('paymentForm');
        const paymentMethodInput = document.getElementById('paymentMethodInput');
        const cardDetails = document.getElementById('card-details');
        const payByCardBtn = document.getElementById('pay-by-card-btn');

        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const method = this.dataset.method;
                // Mark checkout as completed BEFORE submitting the form.
                checkoutCompleted = true; 
                document.getElementById('paymentMethodInput').value = method;

                if (method === 'cash') {
                    document.getElementById('paymentForm').submit();
                } else if (method === 'card') {
                    cardDetails.style.display = 'block';
                }
            });
        });

        // Handle the "Pay Now" button click for card payments
        payByCardBtn.addEventListener('click', () => {
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const cardExpiry = document.getElementById('cardExpiry').value.trim();
            const cardCvc = document.getElementById('cardCvc').value.trim();

            if (!cardNumber || !cardExpiry || !cardCvc) {
                alert('Please fill in all card details before proceeding.');
                return; // Stop the form submission
            }

            // Mark as completed to prevent the cancellation beacon from firing
            checkoutCompleted = true; 
            paymentMethodInput.value = 'card';
            paymentForm.submit();
        });
    </script>
    <script>
        // This script handles the cancellation of the pending contract if the user leaves the page.
        const contractId = '<%= contract.id %>';
        let checkoutCompleted = false;

        // Mark checkout as completed when the form is submitted
        document.getElementById('paymentForm').addEventListener('submit', () => {
            checkoutCompleted = true;
        });

        window.addEventListener('beforeunload', (event) => {
            // If checkout was not completed, send a request to cancel the pending contract.
            if (!checkoutCompleted) {
                // Use navigator.sendBeacon as it's designed for this exact purpose.
                // It reliably sends the request without delaying page unload.
                // Use URLSearchParams to send as 'application/x-www-form-urlencoded'
                navigator.sendBeacon('/renting/cancel-pending', new URLSearchParams({ contract_id: contractId }));
            }
        });
    </script>
</body>
</html>